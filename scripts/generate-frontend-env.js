/**
 * Script para generar variables de entorno del frontend
 * Lee los outputs de CloudFormation y crea .env.production
 */

const { CloudFormationClient, DescribeStacksCommand } = require('@aws-sdk/client-cloudformation');
const fs = require('fs');
const path = require('path');

// Configuraci√≥n
const REGION = process.env.AWS_REGION || 'us-east-1';
const STAGE = process.env.STAGE || 'dev';
const STACK_NAME = `smartboxing-${STAGE}`;

async function generateEnv() {
  try {
    console.log(`üìä Generando variables de entorno para stage: ${STAGE}`);
    console.log(`üîç Consultando stack: ${STACK_NAME}`);
    
    // Cliente de CloudFormation
    const client = new CloudFormationClient({ region: REGION });
    
    // Obtener outputs del stack
    const command = new DescribeStacksCommand({ StackName: STACK_NAME });
    const response = await client.send(command);
    
    if (!response.Stacks || response.Stacks.length === 0) {
      throw new Error(`Stack ${STACK_NAME} no encontrado`);
    }
    
    const stack = response.Stacks[0];
    const outputs = stack.Outputs || [];
    
    console.log(`‚úÖ Stack encontrado con ${outputs.length} outputs`);
    
    // Extraer valores necesarios
    const getOutput = (key) => {
      const output = outputs.find(o => o.OutputKey === key);
      if (!output) {
        console.warn(`‚ö†Ô∏è  Output '${key}' no encontrado`);
        return '';
      }
      return output.OutputValue;
    };
    
    const apiUrl = getOutput('ApiUrl');
    const userPoolId = getOutput('UserPoolId');
    const userPoolClientId = getOutput('UserPoolClientId');
    const cognitoDomain = getOutput('CognitoDomain');
    const frontendUrl = getOutput('FrontendUrl');
    
    // Crear contenido del .env
    const envContent = `# Auto-generated by scripts/generate-frontend-env.js
# Stack: ${STACK_NAME}
# Generated: ${new Date().toISOString()}

# API Configuration
VITE_API_URL=${apiUrl}

# Cognito Configuration
VITE_USER_POOL_ID=${userPoolId}
VITE_USER_POOL_CLIENT_ID=${userPoolClientId}
VITE_COGNITO_DOMAIN=${cognitoDomain}

# Redirect URIs
VITE_REDIRECT_URI=${frontendUrl ? `http://${frontendUrl}/callback` : 'http://localhost:5173/callback'}
VITE_LOGOUT_URI=${frontendUrl ? `http://${frontendUrl}` : 'http://localhost:5173'}

# Environment
VITE_STAGE=${STAGE}
`;
    
    // Escribir archivo
    const envPath = path.join(__dirname, '../frontend/.env.production');
    fs.writeFileSync(envPath, envContent);
    
    console.log(`‚úÖ Variables de entorno generadas en: frontend/.env.production`);
    console.log(`\nüìã Resumen:`);
    console.log(`   API URL: ${apiUrl}`);
    console.log(`   User Pool: ${userPoolId}`);
    console.log(`   Cognito Domain: ${cognitoDomain}`);
    console.log(`   Frontend URL: ${frontendUrl || 'localhost:5173'}`);
    
    // Tambi√©n crear .env.local para desarrollo local
    const envLocalContent = `# Development environment
# Stack: ${STACK_NAME}

# API Configuration
VITE_API_URL=${apiUrl}

# Cognito Configuration
VITE_USER_POOL_ID=${userPoolId}
VITE_USER_POOL_CLIENT_ID=${userPoolClientId}
VITE_COGNITO_DOMAIN=${cognitoDomain}

# Local redirect URIs
VITE_REDIRECT_URI=http://localhost:5173/callback
VITE_LOGOUT_URI=http://localhost:5173

# Environment
VITE_STAGE=${STAGE}
`;
    
    const envLocalPath = path.join(__dirname, '../frontend/.env.local');
    fs.writeFileSync(envLocalPath, envLocalContent);
    
    console.log(`‚úÖ Variables de desarrollo actualizadas en: frontend/.env.local`);
    
  } catch (error) {
    console.error('‚ùå Error al generar variables de entorno:', error.message);
    
    // Si es un error de credenciales, dar m√°s informaci√≥n
    if (error.name === 'CredentialsProviderError') {
      console.error('\nüí° Aseg√∫rate de tener configuradas las credenciales de AWS:');
      console.error('   - AWS_ACCESS_KEY_ID');
      console.error('   - AWS_SECRET_ACCESS_KEY');
      console.error('   - AWS_SESSION_TOKEN (si usas AWS Academy)');
    }
    
    process.exit(1);
  }
}

// Ejecutar
generateEnv();
