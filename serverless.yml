# org: twinmtt
# app: smartboxing
service: smartboxing

useDotenv: true

# Plugins para deploy unificado
plugins:
  - serverless-s3-sync
  - serverless-scriptable-plugin

# ConfiguraciÃ³n de plugins
custom:
  # Sync de archivos frontend a S3 (sin ACL, usar bucket policy)
  s3Sync:
    - bucketName: ${self:service}-frontend-${sls:stage}-v3
      localDir: frontend/dist
      deleteRemoved: true
      # NO usar acl (el bucket tiene ACLs bloqueadas)
      params:
        - index.html:
            CacheControl: 'no-cache, no-store, must-revalidate'
            ContentType: 'text/html'
        - "*.js":
            CacheControl: 'public, max-age=31536000, immutable'
        - "*.css":
            CacheControl: 'public, max-age=31536000, immutable'
        - "*.png":
            CacheControl: 'public, max-age=31536000, immutable'
        - "*.jpg":
            CacheControl: 'public, max-age=31536000, immutable'
        - "*.svg":
            CacheControl: 'public, max-age=31536000, immutable'
        - "*.ico":
            CacheControl: 'public, max-age=31536000, immutable'
  
  # Scripts personalizados
  scriptable:
    hooks:
      # Antes del deploy: build del frontend
      before:deploy:deploy: 
        - echo "ğŸ”¨ Building frontend..."
        - npm run build:frontend
      # DespuÃ©s del deploy: generar variables de entorno
      after:deploy:finalize:
        - echo "âœ… Deploy completed!"
        - echo "ğŸ“Š Generating environment variables..."
        - node scripts/generate-frontend-env.js

provider:
  name: aws
  runtime: nodejs22.x
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  
  # Deployment bucket configuration
  deploymentBucket:
    name: ${self:service}-deployment-${sls:stage}-${aws:accountId}
    serverSideEncryption: AES256
    blockPublicAccess: true
  
  # Performance: Timeout para requests complejos
  timeout: 29  # 29 segundos (API Gateway max es 30s)
  memorySize: 1024  # 1GB RAM para mejor performance
  
  # IAM Role - Sin VPC para mejor performance
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${self:service}-*"
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - !Sub "arn:aws:s3:::${self:service}-*/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !Sub "arn:aws:s3:::${self:service}-*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource:
            - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-*"
        # Permisos para Canary Deployment (CodeDeploy)
        - Effect: Allow
          Action:
            - lambda:PublishVersion
            - lambda:CreateAlias
            - lambda:UpdateAlias
            - lambda:GetAlias
            - lambda:DeleteAlias
            - codedeploy:*
          Resource:
            - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-*"
            - !Sub "arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:*"
  
  # ğŸ”’ VPC Configuration - DESHABILITADO (performance issues)
  # TODO: Investigar Hyperplane ENI setup time en producciÃ³n
  # vpc:
  #   securityGroupIds:
  #     - !Ref LambdaSecurityGroup
  #   subnetIds:
  #     - !Ref PrivateSubnetA
  #     - !Ref PrivateSubnetB
  
  # API Gateway con CORS
  httpApi:
    cors: true
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}"
        audience:
          - !Ref CognitoUserPoolClient

  # Variables de entorno para todas las funciones
  environment:
    T_BOXES: ${self:service}-Boxes-${sls:stage}
    T_STAFF: ${self:service}-Staff-${sls:stage}
    T_APPOINTMENTS: ${self:service}-Appointments-${sls:stage}
    T_PATIENTS: ${self:service}-Patients-${sls:stage}
    T_CLIENT_SETTINGS: ${self:service}-ClientSettings-${sls:stage}
    T_USER_SETTINGS: ${self:service}-UserSettings-${sls:stage}
    USER_POOL_ID: !Ref CognitoUserPool
    USER_POOL_CLIENT_ID: !Ref CognitoUserPoolClient

build:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    target: node22
    platform: node

# Incluir funciones desde backend
functions:
  # âš¡ Warm-up function - Mantiene Lambdas calientes
  warmup:
    handler: backend/src/handlers/warmup.main
    timeout: 60  # 1 minuto para invocar todas las funciones
    events:
      - schedule:
          rate: rate(5 minutes)  # Ejecutar cada 5 minutos
          enabled: true
          description: 'Keep critical Lambda functions warm'
    environment:
      WARMUP_ENABLED: 'true'
  
  # Health check
  health:
    handler: backend/src/handlers/health.main
    events:
      - httpApi:
          path: /health
          method: get

  # ========== BOXES ==========
  listBoxes:
    handler: backend/src/handlers/boxes/list.main
    events:
      - httpApi:
          path: /boxes
          method: get
          authorizer: cognitoJwt
  
  getBox:
    handler: backend/src/handlers/boxes/get.main
    events:
      - httpApi:
          path: /boxes/{id}
          method: get
          authorizer: cognitoJwt
  
  createBox:
    handler: backend/src/handlers/boxes/create.main
    events:
      - httpApi:
          path: /boxes
          method: post
          authorizer: cognitoJwt
  
  updateBox:
    handler: backend/src/handlers/boxes/update.main
    events:
      - httpApi:
          path: /boxes/{id}
          method: put
          authorizer: cognitoJwt
  
  deleteBox:
    handler: backend/src/handlers/boxes/delete.main
    events:
      - httpApi:
          path: /boxes/{id}
          method: delete
          authorizer: cognitoJwt

  # ========== STAFF ========== 
  listStaff:
    handler: backend/src/handlers/staff/list.main
    events:
      - httpApi:
          path: /staff
          method: get
          authorizer: cognitoJwt
  
  getStaffMember:
    handler: backend/src/handlers/staff/get.main
    events:
      - httpApi:
          path: /staff/{id}
          method: get
          authorizer: cognitoJwt
  
  createStaffMember:
    handler: backend/src/handlers/staff/create.main
    events:
      - httpApi:
          path: /staff
          method: post
          authorizer: cognitoJwt
  
  updateStaffMember:
    handler: backend/src/handlers/staff/update.main
    events:
      - httpApi:
          path: /staff/{id}
          method: put
          authorizer: cognitoJwt
  
  deleteStaffMember:
    handler: backend/src/handlers/staff/delete.main
    events:
      - httpApi:
          path: /staff/{id}
          method: delete
          authorizer: cognitoJwt

  # ========== APPOINTMENTS ==========
  listAppointments:
    handler: backend/src/handlers/appointments/list.main
    events:
      - httpApi:
          path: /appointments
          method: get
          authorizer: cognitoJwt
  
  getAppointment:
    handler: backend/src/handlers/appointments/get.main
    events:
      - httpApi:
          path: /appointments/{id}
          method: get
          authorizer: cognitoJwt
  
  createAppointment:
    handler: backend/src/handlers/appointments/create.main
    events:
      - httpApi:
          path: /appointments
          method: post
          authorizer: cognitoJwt
  
  updateAppointment:
    handler: backend/src/handlers/appointments/update.main
    events:
      - httpApi:
          path: /appointments/{id}
          method: put
          authorizer: cognitoJwt
  
  deleteAppointment:
    handler: backend/src/handlers/appointments/delete.main
    events:
      - httpApi:
          path: /appointments/{id}
          method: delete
          authorizer: cognitoJwt

  # ========== PATIENTS ==========
  listPatients:
    handler: backend/src/handlers/patients/list.main
    events:
      - httpApi:
          path: /patients
          method: get
          authorizer: cognitoJwt
  
  getPatient:
    handler: backend/src/handlers/patients/get.main
    events:
      - httpApi:
          path: /patients/{id}
          method: get
          authorizer: cognitoJwt
  
  createPatient:
    handler: backend/src/handlers/patients/create.main
    events:
      - httpApi:
          path: /patients
          method: post
          authorizer: cognitoJwt
  
  updatePatient:
    handler: backend/src/handlers/patients/update.main
    events:
      - httpApi:
          path: /patients/{id}
          method: put
          authorizer: cognitoJwt
  
  deletePatient:
    handler: backend/src/handlers/patients/delete.main
    events:
      - httpApi:
          path: /patients/{id}
          method: delete
          authorizer: cognitoJwt

  # ========== SEED ==========
  seedBulk:
    handler: backend/src/handlers/seed/bulk.main
    events:
      - httpApi:
          path: /seed/bulk
          method: post
          authorizer: cognitoJwt
  
  seedClear:
    handler: backend/src/handlers/seed/clear.main
    events:
      - httpApi:
          path: /seed/clear
          method: delete
          authorizer: cognitoJwt

  # ========== SETTINGS ==========
  getClientSettings:
    handler: backend/src/handlers/settings/client-get.main
    events:
      - httpApi:
          path: /settings/client
          method: get
          authorizer: cognitoJwt
  
  updateClientSettings:
    handler: backend/src/handlers/settings/client-put.main
    events:
      - httpApi:
          path: /settings/client
          method: put
          authorizer: cognitoJwt
  
  uploadLogo:
    handler: backend/src/handlers/settings/upload-logo.main
    events:
      - httpApi:
          path: /settings/upload-logo
          method: post
          authorizer: cognitoJwt
    environment:
      SERVICE_NAME: ${self:service}
      STAGE: ${sls:stage}
  
  getUserSettings:
    handler: backend/src/handlers/settings/user-get.main
    events:
      - httpApi:
          path: /settings/user
          method: get
          authorizer: cognitoJwt
  
  updateUserSettings:
    handler: backend/src/handlers/settings/user-put.main
    events:
      - httpApi:
          path: /settings/user
          method: put
          authorizer: cognitoJwt

  # ========== ANALYTICS ==========
  getDashboard:
    handler: backend/src/handlers/analytics/dashboard.main
    events:
      - httpApi:
          path: /analytics/dashboard
          method: get
          authorizer: cognitoJwt

  # ========== DEPLOYMENT HOOKS (CANARY) ==========
  preTrafficHook:
    handler: backend/src/handlers/deployment/pre-traffic-hook.main
    timeout: 30
    environment:
      AWS_REGION: ${self:provider.region}
    # NO tiene events HTTP, solo se ejecuta por CodeDeploy
  
  postTrafficHook:
    handler: backend/src/handlers/deployment/post-traffic-hook.main
    timeout: 30
    environment:
      AWS_REGION: ${self:provider.region}
    # NO tiene events HTTP, solo se ejecuta por CodeDeploy

resources:
  Resources:
    # ==================== COGNITO ====================
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${sls:stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - Name: email
            Required: true
            Mutable: false
          - Name: name
            Required: false
            Mutable: true
          - Name: tenantId
            AttributeDataType: String
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
        MfaConfiguration: OPTIONAL
        EnabledMfas:
          - SOFTWARE_TOKEN_MFA

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-client-${sls:stage}
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        AllowedOAuthFlows:
          - implicit
        AllowedOAuthScopes:
          - openid
          - email
          - profile
        CallbackURLs:
          - http://localhost:5173/callback
          - !Sub 'https://${CloudFrontDistribution.DomainName}/callback'
        LogoutURLs:
          - http://localhost:5173/login
          - !Sub 'https://${CloudFrontDistribution.DomainName}/login'
        SupportedIdentityProviders:
          - COGNITO
        AllowedOAuthFlowsUserPoolClient: true

    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties:
        Domain: ${self:service}-${sls:stage}-v3
        UserPoolId: !Ref CognitoUserPool

    # ==================== DYNAMODB TABLES ====================
    BoxesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_BOXES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}

    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_STAFF}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}

    AppointmentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_APPOINTMENTS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: startAt
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: ByStartAt
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: startAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}

    PatientsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_PATIENTS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}

    ClientSettingsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_CLIENT_SETTINGS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
        Tags:
          - Key: Environment
            Value: ${sls:stage}

    UserSettingsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_USER_SETTINGS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: userSub
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: userSub
            KeyType: RANGE
        Tags:
          - Key: Environment
            Value: ${sls:stage}

    # ==================== S3 PARA FRONTEND (SIN CLOUDFRONT) ====================
    # Nota: CloudFront deshabilitado debido a restricciones de permisos en AWS Academy
    # El frontend se servirÃ¡ directamente desde S3 Static Website Hosting
    
    FrontendBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-frontend-${sls:stage}-v3
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - HEAD
              AllowedHeaders:
                - '*'

    # CloudFront Origin Access Control (reemplaza OAI)
    CloudFrontOriginAccessControl:
      Type: AWS::CloudFront::OriginAccessControl
      Properties:
        OriginAccessControlConfig:
          Name: ${self:service}-${sls:stage}-oac
          OriginAccessControlOriginType: s3
          SigningBehavior: always
          SigningProtocol: sigv4

    # Bucket Policy para permitir acceso solo desde CloudFront
    FrontendBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref FrontendBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: cloudfront.amazonaws.com
              Action: s3:GetObject
              Resource: !Sub "${FrontendBucket.Arn}/*"
              Condition:
                StringEquals:
                  AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

    # CloudFront Distribution
    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      DependsOn:
        - FrontendBucket
      Properties:
        DistributionConfig:
          Enabled: true
          DefaultRootObject: index.html
          Comment: ${self:service}-${sls:stage} Frontend Distribution
          PriceClass: PriceClass_100  # Solo NA y Europa (mÃ¡s barato)
          HttpVersion: http2and3
          
          Origins:
            - Id: S3Origin
              DomainName: !GetAtt FrontendBucket.RegionalDomainName
              OriginAccessControlId: !Ref CloudFrontOriginAccessControl
              S3OriginConfig: {}
          
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
            ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03  # SecurityHeadersPolicy
          
          CustomErrorResponses:
            - ErrorCode: 403
              ResponseCode: 200
              ResponsePagePath: /index.html
              ErrorCachingMinTTL: 300
            - ErrorCode: 404
              ResponseCode: 200
              ResponsePagePath: /index.html
              ErrorCachingMinTTL: 300
          
          ViewerCertificate:
            CloudFrontDefaultCertificate: true
            MinimumProtocolVersion: TLSv1.2_2021
    
    # ==================== S3 BUCKET PARA ASSETS (LOGOS, IMÃGENES) ====================
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-assets-${sls:stage}-v3
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
        Tags:
          - Key: Environment
            Value: ${sls:stage}
    
    # Bucket Policy para hacer pÃºblicos los logos
    AssetsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref AssetsBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource: !Sub "${AssetsBucket.Arn}/*"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”’ VPC RESOURCES - Seguridad de Red para Lambdas
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. VPC
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: 10.0.0.0/16
        EnableDnsHostnames: true
        EnableDnsSupport: true
        Tags:
          - Key: Name
            Value: ${self:service}-vpc-${sls:stage}
          - Key: Project
            Value: SmartBoxing
          - Key: Environment
            Value: ${sls:stage}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. INTERNET GATEWAY (para subnet pÃºblica)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    InternetGateway:
      Type: AWS::EC2::InternetGateway
      Properties:
        Tags:
          - Key: Name
            Value: ${self:service}-igw-${sls:stage}

    InternetGatewayAttachment:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
        InternetGatewayId: !Ref InternetGateway
        VpcId: !Ref VPC

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. SUBNETS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Subnet PÃšBLICA (para futuro NAT Gateway o Bastion)
    PublicSubnet:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: ${self:provider.region}a
        CidrBlock: 10.0.1.0/24
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: ${self:service}-public-subnet-${sls:stage}
          - Key: Type
            Value: Public

    # Subnets PRIVADAS (para Lambdas)
    PrivateSubnetA:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: ${self:provider.region}a
        CidrBlock: 10.0.10.0/24
        MapPublicIpOnLaunch: false
        Tags:
          - Key: Name
            Value: ${self:service}-private-a-${sls:stage}
          - Key: Type
            Value: Private

    PrivateSubnetB:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: ${self:provider.region}b
        CidrBlock: 10.0.11.0/24
        MapPublicIpOnLaunch: false
        Tags:
          - Key: Name
            Value: ${self:service}-private-b-${sls:stage}
          - Key: Type
            Value: Private

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. ROUTE TABLES
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Route Table PÃšBLICA
    PublicRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: ${self:service}-public-rt-${sls:stage}

    PublicRoute:
      Type: AWS::EC2::Route
      DependsOn: InternetGatewayAttachment
      Properties:
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway

    PublicSubnetRouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet

    # Route Table PRIVADA (sin NAT Gateway - solo VPC Endpoints)
    PrivateRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: ${self:service}-private-rt-${sls:stage}
          - Key: Note
            Value: Sin NAT Gateway - Solo VPC Endpoints (DynamoDB + S3)

    PrivateSubnetARouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PrivateRouteTable
        SubnetId: !Ref PrivateSubnetA

    PrivateSubnetBRouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PrivateRouteTable
        SubnetId: !Ref PrivateSubnetB

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. SECURITY GROUPS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    LambdaSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupName: ${self:service}-lambda-sg-${sls:stage}
        GroupDescription: Security Group for Lambda functions in VPC
        VpcId: !Ref VPC
        # Egress (salida) - permitir HTTPS solo dentro de VPC
        SecurityGroupEgress:
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 10.0.0.0/16
            Description: HTTPS to VPC Endpoints (DynamoDB, S3)
        Tags:
          - Key: Name
            Value: ${self:service}-lambda-sg-${sls:stage}
          - Key: Purpose
            Value: Lambda VPC Security

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6. VPC ENDPOINTS (Gateway - GRATIS)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # DynamoDB Endpoint (Gateway - Sin costo)
    DynamoDBEndpoint:
      Type: AWS::EC2::VPCEndpoint
      Properties:
        VpcId: !Ref VPC
        ServiceName: com.amazonaws.${self:provider.region}.dynamodb
        VpcEndpointType: Gateway
        RouteTableIds:
          - !Ref PrivateRouteTable
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal: '*'
              Action:
                - dynamodb:PutItem
                - dynamodb:GetItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
                - dynamodb:BatchGetItem
                - dynamodb:BatchWriteItem
              Resource:
                - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${self:service}-*"

    # S3 Endpoint (Gateway - Sin costo)
    S3Endpoint:
      Type: AWS::EC2::VPCEndpoint
      Properties:
        VpcId: !Ref VPC
        ServiceName: com.amazonaws.${self:provider.region}.s3
        VpcEndpointType: Gateway
        RouteTableIds:
          - !Ref PrivateRouteTable
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal: '*'
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
                - s3:ListBucket
              Resource:
                - !Sub "arn:aws:s3:::${self:service}-*"
                - !Sub "arn:aws:s3:::${self:service}-*/*"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7. VPC FLOW LOGS (AuditorÃ­a de trÃ¡fico)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    VPCFlowLogsRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: vpc-flow-logs.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: CloudWatchLogPolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                    - logs:DescribeLogGroups
                    - logs:DescribeLogStreams
                  Resource: '*'

    VPCFlowLogsGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/vpc/${self:service}-${sls:stage}
        RetentionInDays: 7

    VPCFlowLog:
      Type: AWS::EC2::FlowLog
      Properties:
        ResourceType: VPC
        ResourceId: !Ref VPC
        TrafficType: ALL
        LogDestinationType: cloud-watch-logs
        LogGroupName: !Ref VPCFlowLogsGroup
        DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
        Tags:
          - Key: Name
            Value: ${self:service}-flow-logs-${sls:stage}

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ¦ CANARY DEPLOYMENT - AWS CODEDEPLOY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # CodeDeploy Application
    CodeDeployApplication:
      Type: AWS::CodeDeploy::Application
      Properties:
        ApplicationName: ${self:service}-${sls:stage}
        ComputePlatform: Lambda
    
    # IAM Role para CodeDeploy
    CodeDeployServiceRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:service}-${sls:stage}-codedeploy-role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: codedeploy.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRoleForLambda
        Policies:
          - PolicyName: CodeDeployLambdaPolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                    - lambda:UpdateAlias
                    - lambda:GetAlias
                    - lambda:GetProvisionedConcurrencyConfig
                  Resource:
                    - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-*"
                - Effect: Allow
                  Action:
                    - cloudwatch:DescribeAlarms
                  Resource: '*'
    
    # SNS Topic para notificaciones de canary
    CanaryAlertTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${sls:stage}-canary-alerts
        DisplayName: SmartBoxing Canary Deployment Alerts
        Subscriptions:
          - Endpoint: milan.munoz@udd.cl
            Protocol: email
    
    # CloudWatch Alarm: Error Rate > 5%
    CanaryErrorAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${sls:stage}-canary-errors
        AlarmDescription: Canary deployment error rate is too high
        MetricName: Errors
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 60
        EvaluationPeriods: 2
        Threshold: 5
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        ActionsEnabled: true
        AlarmActions:
          - !Ref CanaryAlertTopic
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${sls:stage}-listBoxes
    
    # CloudWatch Alarm: Latency p99 > 2000ms
    CanaryLatencyAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${sls:stage}-canary-latency
        AlarmDescription: Canary deployment latency is too high
        MetricName: Duration
        Namespace: AWS/Lambda
        ExtendedStatistic: p99
        Period: 60
        EvaluationPeriods: 2
        Threshold: 2000
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        ActionsEnabled: true
        AlarmActions:
          - !Ref CanaryAlertTopic
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${sls:stage}-listBoxes
    
    # CloudWatch Alarm: Throttle Rate > 1%
    CanaryThrottleAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${sls:stage}-canary-throttles
        AlarmDescription: Canary deployment throttle rate is too high
        MetricName: Throttles
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 60
        EvaluationPeriods: 2
        Threshold: 5
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        ActionsEnabled: true
        AlarmActions:
          - !Ref CanaryAlertTopic

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OUTPUTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Outputs:
    # API
    ApiUrl:
      Description: URL del API Gateway
      Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"
      Export:
        Name: ${self:service}-${sls:stage}-ApiUrl

    # Cognito
    UserPoolId:
      Description: ID del Cognito User Pool
      Value: !Ref CognitoUserPool
      Export:
        Name: ${self:service}-${sls:stage}-UserPoolId

    UserPoolClientId:
      Description: ID del Cognito User Pool Client
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: ${self:service}-${sls:stage}-UserPoolClientId

    CognitoDomain:
      Description: Dominio de Cognito para login
      Value: !Sub "https://${CognitoUserPoolDomain}.auth.${AWS::Region}.amazoncognito.com"
      Export:
        Name: ${self:service}-${sls:stage}-CognitoDomain

    # Frontend
    FrontendBucketName:
      Description: Nombre del bucket S3 para frontend
      Value: !Ref FrontendBucket
      Export:
        Name: ${self:service}-${sls:stage}-FrontendBucket

    FrontendUrl:
      Description: URL del frontend (S3 Static Website - Deprecated, usar CloudFrontUrl)
      Value: !Sub "http://${FrontendBucket}.s3-website-${AWS::Region}.amazonaws.com"
      Export:
        Name: ${self:service}-${sls:stage}-FrontendUrl

    CloudFrontUrl:
      Description: URL del frontend (CloudFront HTTPS) - URL PRINCIPAL
      Value: !Sub "https://${CloudFrontDistribution.DomainName}"
      Export:
        Name: ${self:service}-${sls:stage}-CloudFrontUrl
    
    CloudFrontDistributionId:
      Description: ID de la distribucion CloudFront
      Value: !Ref CloudFrontDistribution
      Export:
        Name: ${self:service}-${sls:stage}-CloudFrontDistributionId

    # DynamoDB Tables
    BoxesTableName:
      Description: Nombre de la tabla Boxes
      Value: !Ref BoxesTable

    StaffTableName:
      Description: Nombre de la tabla Staff
      Value: !Ref StaffTable

    AppointmentsTableName:
      Description: Nombre de la tabla Appointments
      Value: !Ref AppointmentsTable

    PatientsTableName:
      Description: Nombre de la tabla Patients
      Value: !Ref PatientsTable

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”’ VPC Outputs
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    VPCId:
      Description: VPC ID
      Value: !Ref VPC
      Export:
        Name: ${self:service}-VPCId-${sls:stage}

    VPCCidr:
      Description: VPC CIDR Block
      Value: 10.0.0.0/16
      Export:
        Name: ${self:service}-VPCCidr-${sls:stage}

    PublicSubnetId:
      Description: Public Subnet ID
      Value: !Ref PublicSubnet
      Export:
        Name: ${self:service}-PublicSubnet-${sls:stage}

    PrivateSubnetAId:
      Description: Private Subnet A ID (AZ-a)
      Value: !Ref PrivateSubnetA
      Export:
        Name: ${self:service}-PrivateSubnetA-${sls:stage}

    PrivateSubnetBId:
      Description: Private Subnet B ID (AZ-b)
      Value: !Ref PrivateSubnetB
      Export:
        Name: ${self:service}-PrivateSubnetB-${sls:stage}

    LambdaSecurityGroupId:
      Description: Lambda Security Group ID
      Value: !Ref LambdaSecurityGroup
      Export:
        Name: ${self:service}-LambdaSG-${sls:stage}

    DynamoDBEndpointId:
      Description: DynamoDB VPC Endpoint ID
      Value: !Ref DynamoDBEndpoint
      Export:
        Name: ${self:service}-DynamoDBEndpoint-${sls:stage}

    S3EndpointId:
      Description: S3 VPC Endpoint ID
      Value: !Ref S3Endpoint
      Export:
        Name: ${self:service}-S3Endpoint-${sls:stage}

    VPCFlowLogsGroupName:
      Description: VPC Flow Logs CloudWatch Log Group
      Value: !Ref VPCFlowLogsGroup
      Export:
        Name: ${self:service}-FlowLogs-${sls:stage}
