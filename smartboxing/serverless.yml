service: smartboxing-node
frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  role: arn:aws:iam::058264413807:role/LabRole
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  httpApi:
    cors: true
    authorizers:
      cognitoJwt:
        identitySource: '$request.header.Authorization'
        # evita referencias encadenadas: usa env directo
        issuerUrl: https://cognito-idp.${env:AWS_REGION, 'us-east-1'}.amazonaws.com/${env:USER_POOL_ID}
        audience:
          - ${env:USER_POOL_CLIENT_ID}
  environment:
    T_CLIENTSET: ${self:service}-ClientSettings-${sls:stage}
    T_USERSET:   ${self:service}-UserSettings-${sls:stage}
    T_PERMS: ${self:service}-Permissions-${sls:stage}
    T_ROLES: ${self:service}-Roles-${sls:stage}
    T_USERROLES: ${self:service}-UserRoles-${sls:stage}
    # Business tables
    T_EQUIPMENT: ${self:service}-Equipment-${sls:stage}
    T_BOXES: ${self:service}-Boxes-${sls:stage}
    T_BOX_EQUIPMENT: ${self:service}-BoxEquipment-${sls:stage}
    T_SPECIALTIES: ${self:service}-Specialties-${sls:stage}
    T_DOCTORS: ${self:service}-Doctors-${sls:stage}
    T_VACATIONS: ${self:service}-Vacations-${sls:stage}
    T_BOX_ASSIGNMENTS: ${self:service}-BoxAssignments-${sls:stage}
    T_APPOINTMENTS: ${self:service}-Appointments-${sls:stage}

functions:
  authMe:
    handler: backend/src/handlers/auth/me.handler
    events:
      - httpApi:
          path: /auth/me
          method: get
          authorizer: cognitoJwt

  personalizationGet:
    handler: backend/src/handlers/personalization/get.handler
    events:
      - httpApi:
          path: /personalization
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem ]
        Resource:
          - { "Fn::GetAtt": [ ClientSettings, Arn ] }
          - { "Fn::GetAtt": [ UserSettings, Arn ] }

  personalizationUpdateClient:
    handler: backend/src/handlers/personalization/update-client.handler
    events:
      - httpApi:
          path: /personalization/client
          method: put
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem, dynamodb:Scan, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ ClientSettings, Arn ] }
          - { "Fn::GetAtt": [ Permissions, Arn ] }
          - { "Fn::GetAtt": [ Roles, Arn ] }
          - { "Fn::GetAtt": [ UserRoles, Arn ] }

  personalizationUpdateMe:
    handler: backend/src/handlers/personalization/update-me.handler
    events:
      - httpApi:
          path: /personalization/me
          method: put
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem ]
        Resource: { "Fn::GetAtt": [ UserSettings, Arn ] }
    
  permissionsList:
    handler: backend/src/handlers/authz/permissions-list.handler
    events:
      - httpApi:
          path: /permissions
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan ]
        Resource: { "Fn::GetAtt": [ Permissions, Arn ] }

  rolesUpsert:
    handler: backend/src/handlers/authz/roles-upsert.handler
    events:
      - httpApi:
          path: /roles
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem ]
        Resource: { "Fn::GetAtt": [ Roles, Arn ] }

  rolesAssign:
    handler: backend/src/handlers/authz/roles-assign.handler
    events:
      - httpApi:
          path: /roles/assign
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem, dynamodb:GetItem ]
        Resource: { "Fn::GetAtt": [ UserRoles, Arn ] }

  # Boxes endpoints
  boxesList:
    handler: backend/src/handlers/boxes/list.handler
    events:
      - httpApi:
          path: /boxes
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ Boxes, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ Boxes, Arn ] }, "index", "*" ] ] }

  boxGet:
    handler: backend/src/handlers/boxes/get.handler
    events:
      - httpApi:
          path: /boxes/{id}
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem ]
        Resource: { "Fn::GetAtt": [ Boxes, Arn ] }

  boxCreate:
    handler: backend/src/handlers/boxes/create.handler
    events:
      - httpApi:
          path: /boxes
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem ]
        Resource: { "Fn::GetAtt": [ Boxes, Arn ] }

  boxUpdate:
    handler: backend/src/handlers/boxes/update.handler
    events:
      - httpApi:
          path: /boxes/{id}
          method: put
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:UpdateItem ]
        Resource: { "Fn::GetAtt": [ Boxes, Arn ] }

  boxDelete:
    handler: backend/src/handlers/boxes/delete.handler
    events:
      - httpApi:
          path: /boxes/{id}
          method: delete
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:DeleteItem ]
        Resource: { "Fn::GetAtt": [ Boxes, Arn ] }

  # Specialties endpoints
  specialtiesList:
    handler: backend/src/handlers/specialties/list.handler
    events:
      - httpApi:
          path: /specialties
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan ]
        Resource: { "Fn::GetAtt": [ Specialties, Arn ] }

  # Doctors endpoints
  doctorsList:
    handler: backend/src/handlers/doctors/list.handler
    events:
      - httpApi:
          path: /doctors
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ Doctors, Arn ] }
          - { "Fn::GetAtt": [ Vacations, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ Vacations, Arn ] }, "index", "*" ] ] }

  doctorCreate:
    handler: backend/src/handlers/doctors/create.handler
    events:
      - httpApi:
          path: /doctors
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem ]
        Resource: { "Fn::GetAtt": [ Doctors, Arn ] }

  doctorUpdate:
    handler: backend/src/handlers/doctors/update.handler
    events:
      - httpApi:
          path: /doctors/{id}
          method: put
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:UpdateItem ]
        Resource: { "Fn::GetAtt": [ Doctors, Arn ] }

  doctorDelete:
    handler: backend/src/handlers/doctors/delete.handler
    events:
      - httpApi:
          path: /doctors/{id}
          method: delete
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:DeleteItem ]
        Resource: { "Fn::GetAtt": [ Doctors, Arn ] }

  # Vacations endpoints
  vacationsList:
    handler: backend/src/handlers/vacations/list.handler
    events:
      - httpApi:
          path: /vacations
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ Vacations, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ Vacations, Arn ] }, "index", "*" ] ] }

  vacationCreate:
    handler: backend/src/handlers/vacations/create.handler
    events:
      - httpApi:
          path: /vacations
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem ]
        Resource: { "Fn::GetAtt": [ Vacations, Arn ] }

  vacationDelete:
    handler: backend/src/handlers/vacations/delete.handler
    events:
      - httpApi:
          path: /vacations/{id}
          method: delete
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:DeleteItem ]
        Resource: { "Fn::GetAtt": [ Vacations, Arn ] }

  # Box Assignments endpoints
  assignmentsList:
    handler: backend/src/handlers/assignments/list.handler
    events:
      - httpApi:
          path: /box-assignments
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ BoxAssignments, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ BoxAssignments, Arn ] }, "index", "*" ] ] }

  assignmentCreate:
    handler: backend/src/handlers/assignments/create.handler
    events:
      - httpApi:
          path: /box-assignments
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ BoxAssignments, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ BoxAssignments, Arn ] }, "index", "*" ] ] }

  assignmentUpdate:
    handler: backend/src/handlers/assignments/update.handler
    events:
      - httpApi:
          path: /box-assignments/{id}
          method: put
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:UpdateItem, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ BoxAssignments, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ BoxAssignments, Arn ] }, "index", "*" ] ] }

  assignmentDelete:
    handler: backend/src/handlers/assignments/delete.handler
    events:
      - httpApi:
          path: /box-assignments/{id}
          method: delete
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:DeleteItem ]
        Resource: { "Fn::GetAtt": [ BoxAssignments, Arn ] }

  # Appointments endpoints
  appointmentsList:
    handler: backend/src/handlers/appointments/list.handler
    events:
      - httpApi:
          path: /appointments
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:Scan, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ Appointments, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ Appointments, Arn ] }, "index", "*" ] ] }

  appointmentGet:
    handler: backend/src/handlers/appointments/get.handler
    events:
      - httpApi:
          path: /appointments/{id}
          method: get
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem ]
        Resource: { "Fn::GetAtt": [ Appointments, Arn ] }

  appointmentCreate:
    handler: backend/src/handlers/appointments/create.handler
    events:
      - httpApi:
          path: /appointments
          method: post
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:PutItem, dynamodb:GetItem, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ Appointments, Arn ] }
          - { "Fn::GetAtt": [ BoxAssignments, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ Appointments, Arn ] }, "index", "*" ] ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ BoxAssignments, Arn ] }, "index", "*" ] ] }

  appointmentUpdate:
    handler: backend/src/handlers/appointments/update.handler
    events:
      - httpApi:
          path: /appointments/{id}
          method: put
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:PutItem, dynamodb:Query ]
        Resource:
          - { "Fn::GetAtt": [ Appointments, Arn ] }
          - { "Fn::GetAtt": [ BoxAssignments, Arn ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ Appointments, Arn ] }, "index", "*" ] ] }
          - { "Fn::Join": [ "/", [ { "Fn::GetAtt": [ BoxAssignments, Arn ] }, "index", "*" ] ] }

  appointmentDelete:
    handler: backend/src/handlers/appointments/delete.handler
    events:
      - httpApi:
          path: /appointments/{id}
          method: delete
          authorizer: cognitoJwt
    iamRoleStatements:
      - Effect: Allow
        Action: [ dynamodb:GetItem, dynamodb:DeleteItem ]
        Resource: { "Fn::GetAtt": [ Appointments, Arn ] }


resources:
  Resources:

    ClientSettings:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_CLIENTSET}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: tenantId, AttributeType: S }
        KeySchema:
          - { AttributeName: tenantId, KeyType: HASH }

    UserSettings:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_USERSET}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: userKey, AttributeType: S }   # <tenantId>#<sub>
        KeySchema:
          - { AttributeName: userKey, KeyType: HASH }

    Permissions:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_PERMS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions: [ { AttributeName: perm, AttributeType: S } ]
        KeySchema: [ { AttributeName: perm, KeyType: HASH } ]

    Roles:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_ROLES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions: [ { AttributeName: roleId, AttributeType: S } ]
        KeySchema: [ { AttributeName: roleId, KeyType: HASH } ]

    UserRoles:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_USERROLES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions: [ { AttributeName: userKey, AttributeType: S } ] # <tenantId>#<sub>
        KeySchema: [ { AttributeName: userKey, KeyType: HASH } ]

    # Business Tables

    Equipment:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_EQUIPMENT}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions: [ { AttributeName: name, AttributeType: S } ]
        KeySchema: [ { AttributeName: name, KeyType: HASH } ]

    Boxes:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_BOXES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: id, AttributeType: S }
          - { AttributeName: operational_status, AttributeType: S }
          - { AttributeName: number, AttributeType: N }
        KeySchema: [ { AttributeName: id, KeyType: HASH } ]
        GlobalSecondaryIndexes:
          - IndexName: OSIndex
            KeySchema:
              - { AttributeName: operational_status, KeyType: HASH }
              - { AttributeName: number, KeyType: RANGE }
            Projection: { ProjectionType: ALL }

    BoxEquipment:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_BOX_EQUIPMENT}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: boxKey, AttributeType: S }
          - { AttributeName: eqKey, AttributeType: S }
        KeySchema:
          - { AttributeName: boxKey, KeyType: HASH }
          - { AttributeName: eqKey, KeyType: RANGE }

    Specialties:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_SPECIALTIES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions: [ { AttributeName: id, AttributeType: S } ]
        KeySchema: [ { AttributeName: id, KeyType: HASH } ]

    Doctors:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_DOCTORS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions: [ { AttributeName: id, AttributeType: S } ]
        KeySchema: [ { AttributeName: id, KeyType: HASH } ]

    Vacations:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_VACATIONS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: id, AttributeType: S }
          - { AttributeName: doctorId, AttributeType: S }
          - { AttributeName: start_date, AttributeType: S }
        KeySchema: [ { AttributeName: id, KeyType: HASH } ]
        GlobalSecondaryIndexes:
          - IndexName: VacationsByDoctor
            KeySchema:
              - { AttributeName: doctorId, KeyType: HASH }
              - { AttributeName: start_date, KeyType: RANGE }
            Projection: { ProjectionType: ALL }

    BoxAssignments:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_BOX_ASSIGNMENTS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: id, AttributeType: S }
          - { AttributeName: doctorId, AttributeType: S }
          - { AttributeName: boxId, AttributeType: S }
          - { AttributeName: date, AttributeType: S }
          - { AttributeName: start_time, AttributeType: S }
        KeySchema: [ { AttributeName: id, KeyType: HASH } ]
        GlobalSecondaryIndexes:
          - IndexName: AssignmentsByDoctor
            KeySchema:
              - { AttributeName: doctorId, KeyType: HASH }
              - { AttributeName: start_time, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
          - IndexName: AssignmentsByBox
            KeySchema:
              - { AttributeName: boxId, KeyType: HASH }
              - { AttributeName: start_time, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
          - IndexName: AssignmentsByDate
            KeySchema:
              - { AttributeName: date, KeyType: HASH }
              - { AttributeName: start_time, KeyType: RANGE }
            Projection: { ProjectionType: ALL }

    Appointments:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.T_APPOINTMENTS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: id, AttributeType: S }
          - { AttributeName: assignmentId, AttributeType: S }
          - { AttributeName: date, AttributeType: S }
          - { AttributeName: doctorId, AttributeType: S }
          - { AttributeName: start_time, AttributeType: S }
        KeySchema: [ { AttributeName: id, KeyType: HASH } ]
        GlobalSecondaryIndexes:
          - IndexName: ApptByAssignment
            KeySchema:
              - { AttributeName: assignmentId, KeyType: HASH }
              - { AttributeName: start_time, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
          - IndexName: ApptByDate
            KeySchema:
              - { AttributeName: date, KeyType: HASH }
              - { AttributeName: start_time, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
          - IndexName: ApptByDoctorDate
            KeySchema:
              - { AttributeName: doctorId, KeyType: HASH }
              - { AttributeName: date, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
